<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contr√¥le Caisse Site</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h2 {
            color: #333;
            margin-top: 0;
        }
        
        /* S√©lecteur de caisse */
        .caisse-selector {
            background: #fff3cd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            border: 1px solid #ffc107;
        }
        
        .caisse-selector label {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .caisse-selector select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }
        
        /* Totaux globaux */
        .totaux {
            background: #e3f2fd;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #1976d2;
            border-radius: 4px;
        }
        
        .totaux h3 {
            margin-top: 0;
            color: #1976d2;
        }
        
        .totaux p {
            margin: 8px 0;
        }
        
        /* Cartes entit√©s */
        .entites-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .entite-card {
            background: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .entite-card h4 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 8px;
        }
        
        .entite-card .stats {
            margin: 10px 0;
            font-size: 14px;
        }
        
        .entite-card .stats p {
            margin: 5px 0;
        }
        
        /* Commentaires */
        .comment-label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        
        .comment-global {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        
        /* Boutons */
        .btn-container {
            margin-top: 20px;
            text-align: right;
        }
        
        .btn-sauvegarder {
            background: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-sauvegarder:hover {
            background: #45a049;
        }
        
        .btn-sauvegarder:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Messages */
        .message {
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>üîç Contr√¥le Caisse Site</h2>
        
        <!-- Message de statut -->
        <div id="message" class="message"></div>
        
        <!-- S√©lecteur de caisse -->
        <div class="caisse-selector">
            <label for="caisseSelect">üìå S√©lectionner une caisse :</label>
            <select id="caisseSelect">
                <option value="">Chargement...</option>
            </select>
        </div>
        
        <!-- Totaux globaux -->
        <div class="totaux" id="totaux">
            <h3>üìä Totaux Globaux</h3>
            <p>Chargement des donn√©es...</p>
        </div>
        
        <!-- D√©tails par entit√© -->
        <h3>üìã D√©tails Par Entit√©</h3>
        <div class="entites-container" id="entitesContainer">
            <p>Chargement...</p>
        </div>
        
        <!-- Commentaire global -->
        <div class="comment-global">
            <label class="comment-label">üí¨ Commentaire Global Contr√¥le Site :</label>
            <textarea id="commentGlobal" rows="4" placeholder="Saisissez un commentaire global sur ce contr√¥le..."></textarea>
        </div>
        
        <!-- Bouton de sauvegarde -->
        <div class="btn-container">
            <button id="btnSauvegarder" class="btn-sauvegarder">üíæ SAUVEGARDER TOUS LES COMMENTAIRES</button>
        </div>
    </div>

    <!-- SDK Zoho Creator -->
    <script src="https://js.zohostatic.com/creator/widgets/version/2.0/widgetsdk-min.js"></script>
    
    <!-- Notre JavaScript -->
    <script>
        // Configuration
        const APP_NAME = "one-process";
        const REPORT_NAME = "All_Caisses_sites";
        const FORM_NAME = "Caisses_sites";
        
        let currentCaisseID = null;
        let caisseData = null;
        let entitesData = [];
        
        // Initialisation
        ZOHO.CREATOR.init().then(function() {
            console.log("‚úÖ Widget initialis√© !");
            chargerListeCaisses();
        }).catch(function(error) {
            afficherMessage("Erreur d'initialisation : " + error, "error");
            console.error("Erreur init:", error);
        });
        
        // Charger la liste des caisses
        function chargerListeCaisses() {
            const config = {
                appName: APP_NAME,
                reportName: REPORT_NAME,
                page: 1,
                pageSize: 200
            };
            
            ZOHO.CREATOR.API.getAllRecords(config).then(function(response) {
                const caisses = response.data;
                const select = document.getElementById('caisseSelect');
                select.innerHTML = '<option value="">-- S√©lectionnez une caisse --</option>';
                
                caisses.forEach(function(caisse) {
                    const option = document.createElement('option');
                    option.value = caisse.ID;
                    option.textContent = caisse.Nom_Caisse_Site || 'Caisse #' + caisse.ID;
                    select.appendChild(option);
                });
                
                // √âv√©nement changement de caisse
                select.addEventListener('change', function() {
                    if (this.value) {
                        chargerDonneesCaisse(this.value);
                    }
                });
                
            }).catch(function(error) {
                afficherMessage("Erreur chargement caisses : " + error, "error");
                console.error("Erreur:", error);
            });
        }
        
        // Charger les donn√©es d'une caisse
        function chargerDonneesCaisse(caisseID) {
            afficherMessage("Chargement des donn√©es...", "loading");
            currentCaisseID = caisseID;
            
            const config = {
                appName: APP_NAME,
                reportName: REPORT_NAME,
                id: caisseID
            };
            
            ZOHO.CREATOR.API.getRecordById(config).then(function(response) {
                caisseData = response.data;
                afficherDonnees();
                afficherMessage("", "");
            }).catch(function(error) {
                afficherMessage("Erreur chargement donn√©es : " + error, "error");
                console.error("Erreur:", error);
            });
        }
        
        // Afficher les donn√©es
        function afficherDonnees() {
            // Totaux globaux
            document.getElementById('totaux').innerHTML = `
                <h3>üìä Totaux Globaux</h3>
                <p><strong>Total D√©cla:</strong> ${caisseData.TOTAL_DECLA_SITE || 0} ‚Ç¨</p>
                <p><strong>Total DC:</strong> ${caisseData.TOTAL_SITE_DC || 0} ‚Ç¨</p>
                <p><strong>√âcart:</strong> ${caisseData.ECART_SITE_DECLA_VS_DC || 0} ‚Ç¨</p>
            `;
            
            // Commentaire global existant
            document.getElementById('commentGlobal').value = caisseData.Commentaire_Controle_Site || '';
            
            // D√©tails par entit√©
            entitesData = caisseData.Detail_Par_Entite || [];
            const container = document.getElementById('entitesContainer');
            
            if (entitesData.length === 0) {
                container.innerHTML = '<p>Aucune entit√© trouv√©e</p>';
                return;
            }
            
            container.innerHTML = '';
            entitesData.forEach(function(detail, index) {
                const nomEntite = detail.Entite ? detail.Entite.display_value : 'Entit√© inconnue';
                const card = document.createElement('div');
                card.className = 'entite-card';
                card.innerHTML = `
                    <h4>${nomEntite}</h4>
                    <div class="stats">
                        <p><strong>CB D√©cla:</strong> ${detail.DECLA_SITE_TOTAL_TPE || 0} ‚Ç¨</p>
                        <p><strong>DC CB:</strong> ${detail.DC_ENCAISSEMENT_CB_TOTAL || 0} ‚Ç¨</p>
                        <p><strong>√âcart:</strong> ${detail.ECART_DECLA_TPE_VS_DC_CB || 0} ‚Ç¨</p>
                    </div>
                    <label class="comment-label">üí¨ Commentaire :</label>
                    <textarea id="comment_${index}" rows="3" placeholder="Commentaire pour ${nomEntite}...">${detail.Commentaire_CB_vs_DC || ''}</textarea>
                `;
                container.appendChild(card);
            });
        }
        
        // Sauvegarder
        document.getElementById('btnSauvegarder').addEventListener('click', function() {
            if (!currentCaisseID) {
                afficherMessage("Veuillez s√©lectionner une caisse", "error");
                return;
            }
            
            // Collecter tous les commentaires
            const commentaires = {
                global: document.getElementById('commentGlobal').value,
                entites: []
            };
            
            entitesData.forEach(function(detail, index) {
                const textarea = document.getElementById('comment_' + index);
                if (textarea) {
                    commentaires.entites.push({
                        nomEntite: detail.Entite ? detail.Entite.display_value : '',
                        commentaire: textarea.value,
                        detailOriginal: detail
                    });
                }
            });
            
            // D√©sactiver le bouton
            const btn = document.getElementById('btnSauvegarder');
            btn.disabled = true;
            btn.textContent = '‚è≥ Sauvegarde en cours...';
            
            afficherMessage("Sauvegarde en cours...", "loading");
            
            // TODO: Appeler une fonction Deluge standalone
            // Pour l'instant, on fait un simple console.log
            console.log("Donn√©es √† sauvegarder:", commentaires);
            
            // Simuler une sauvegarde (√Ä REMPLACER par l'appel r√©el)
            setTimeout(function() {
                afficherMessage("‚úÖ Commentaires sauvegard√©s avec succ√®s !", "success");
                btn.disabled = false;
                btn.textContent = 'üíæ SAUVEGARDER TOUS LES COMMENTAIRES';
            }, 1000);
        });
        
        // Afficher un message
        function afficherMessage(texte, type) {
            const messageDiv = document.getElementById('message');
            if (!texte) {
                messageDiv.style.display = 'none';
                return;
            }
            
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            
            if (type === 'loading') {
                messageDiv.innerHTML = '<span class="spinner"></span>' + texte;
            } else {
                messageDiv.textContent = texte;
            }
        }
    </script>
</body>
</html>